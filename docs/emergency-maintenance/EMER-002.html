<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-emergency-maintenance/EMER-002">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">Recovering the Cluster | GraphDB AWS deployment guide</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://ontotext-ad.github.io/graphdb-aws-deployment-guide/docs/emergency-maintenance/EMER-002"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Recovering the Cluster | GraphDB AWS deployment guide"><meta data-rh="true" name="description" content="The GraphDB cluster relies on quorum-based replication, meaning that the cluster should have over 50% alive nodes"><meta data-rh="true" property="og:description" content="The GraphDB cluster relies on quorum-based replication, meaning that the cluster should have over 50% alive nodes"><link data-rh="true" rel="icon" href="/graphdb-aws-deployment-guide/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://ontotext-ad.github.io/graphdb-aws-deployment-guide/docs/emergency-maintenance/EMER-002"><link data-rh="true" rel="alternate" href="https://ontotext-ad.github.io/graphdb-aws-deployment-guide/docs/emergency-maintenance/EMER-002" hreflang="en"><link data-rh="true" rel="alternate" href="https://ontotext-ad.github.io/graphdb-aws-deployment-guide/docs/emergency-maintenance/EMER-002" hreflang="x-default"><link rel="stylesheet" href="/graphdb-aws-deployment-guide/assets/css/styles.e55a43fc.css">
<link rel="preload" href="/graphdb-aws-deployment-guide/assets/js/runtime~main.98a356ba.js" as="script">
<link rel="preload" href="/graphdb-aws-deployment-guide/assets/js/main.5c81d43a.js" as="script">
</head>
<body class="navigation-with-keyboard" data-theme="light">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top navbar--dark"><div class="navbar__inner"><div class="navbar__items"><a class="navbar__brand" href="/graphdb-aws-deployment-guide/"><div class="navbar__logo"><img src="/graphdb-aws-deployment-guide/img/logo.svg" alt="Ontotext logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/graphdb-aws-deployment-guide/img/logo.svg" alt="Ontotext logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">GraphDB AWS Deployment Guide</b></a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS darkNavbarColorModeToggle_X3D1" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><div class="dsla-search-wrapper"><div class="dsla-search-field" data-tags="default,docs-default-current"></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/graphdb-aws-deployment-guide/docs/about">About</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/graphdb-aws-deployment-guide/docs/category/introduction">Introduction</a><button aria-label="Toggle the collapsible sidebar category &#x27;Introduction&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/graphdb-aws-deployment-guide/docs/category/prerequisites-and-requirements">Prerequisites and Requirements</a><button aria-label="Toggle the collapsible sidebar category &#x27;Prerequisites and Requirements&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/graphdb-aws-deployment-guide/docs/category/architecture">Architecture</a><button aria-label="Toggle the collapsible sidebar category &#x27;Architecture&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/graphdb-aws-deployment-guide/docs/category/security">Security</a><button aria-label="Toggle the collapsible sidebar category &#x27;Security&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/graphdb-aws-deployment-guide/docs/category/costs">Costs</a><button aria-label="Toggle the collapsible sidebar category &#x27;Costs&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/graphdb-aws-deployment-guide/docs/category/sizing">Sizing</a><button aria-label="Toggle the collapsible sidebar category &#x27;Sizing&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/graphdb-aws-deployment-guide/docs/category/deployment-assets">Deployment Assets</a><button aria-label="Toggle the collapsible sidebar category &#x27;Deployment Assets&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/graphdb-aws-deployment-guide/docs/category/health-check">Health Check</a><button aria-label="Toggle the collapsible sidebar category &#x27;Health Check&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/graphdb-aws-deployment-guide/docs/category/backup-and-recovery">Backup and Recovery</a><button aria-label="Toggle the collapsible sidebar category &#x27;Backup and Recovery&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/graphdb-aws-deployment-guide/docs/category/routine-maintenance">Routine Maintenance</a><button aria-label="Toggle the collapsible sidebar category &#x27;Routine Maintenance&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/graphdb-aws-deployment-guide/docs/category/emergency-maintenance">Emergency Maintenance</a><button aria-label="Toggle the collapsible sidebar category &#x27;Emergency Maintenance&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/graphdb-aws-deployment-guide/docs/emergency-maintenance/EMER-001">Handling Fault Conditions</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/graphdb-aws-deployment-guide/docs/emergency-maintenance/EMER-002">Recovering the Cluster</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/graphdb-aws-deployment-guide/docs/category/support">Support</a><button aria-label="Toggle the collapsible sidebar category &#x27;Support&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/graphdb-aws-deployment-guide/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/graphdb-aws-deployment-guide/docs/category/emergency-maintenance"><span itemprop="name">Emergency Maintenance</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Recovering the Cluster</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Recovering the Cluster</h1><p>The GraphDB cluster relies on quorum-based replication, meaning that the cluster should have over 50% alive nodes
to be able to execute INSERT/DELETE operations.
This ensures that there will always be a majority of GraphDB nodes that always have up-to-date data.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="recovering-individual-nodes">Recovering Individual Nodes<a href="#recovering-individual-nodes" class="hash-link" aria-label="Direct link to Recovering Individual Nodes" title="Direct link to Recovering Individual Nodes">​</a></h2><p>The following procedure describes how to recover one or multiple failed nodes:</p><ol><li>Determine if quorum is impacted.<ul><li>If there is not enough nodes to form a quorum,
consult the <a href="#rebuilding-the-cluster-from-a-single-node">Rebuilding the cluster from a single node</a> procedure. </li></ul></li><li>If new nodes can be added with the previously used hostname or IP address
(depending on how the nodes were added to the cluster), then:<ul><li>Start the new nodes with the same address or hostname.
After this, the cluster should be able to determine that the nodes are available again
and start “catching” them up with missed updates.</li><li>If the volume from the failed node can be mounted to the new nodes, you should do so,
to avoid full replication from scratch, which could be time-consuming.</li></ul></li><li>If nodes cannot reuse the previous IP address or hostname:<ul><li>First remove the failed nodes from the cluster.</li><li>Add the new nodes to the cluster, it’s important to add all new nodes in a single rest call.
This will avoid building and sending a snapshot multiple times.
Please note that this will trigger full replication, and it could be time-consuming depending on the size of the repository.   </li></ul></li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="rebuilding-the-cluster-from-a-single-node">Rebuilding the Cluster from a Single Node<a href="#rebuilding-the-cluster-from-a-single-node" class="hash-link" aria-label="Direct link to Rebuilding the Cluster from a Single Node" title="Direct link to Rebuilding the Cluster from a Single Node">​</a></h2><p>Sometimes, multiple nodes can fail or in other situations:</p><ul><li>nodes might be available,but cannot agree on the state of the cluster, </li><li>cannot agree, which the leader is, and the cluster will be in a deadlocked state, unable to process write or even read requests.</li></ul><p>In such cases, the cluster can be rebuilt from a single node. </p><p>Use the following procedure to rebuild the cluster from a single node:</p><ol><li>Double check there is connectivity between the nodes.</li><li>Stop the GraphDB processes on all nodes. </li><li>Determine the node with the highest number of processed transactions.
This corresponds to the log index maintained by GraphDB (Raft).
The steps to retrieve the log index for each node are as follows:<ul><li>Get access to the nodes file system, where GraphDB stores its data.</li><li>Determine the size (in bytes) of <code>log.index</code> file.
The location of this file is relative to the configured GraphDB data directory and has the following path <code>raft/transaction-log/log.index</code>.</li><li>Use the following formula to calculate the log index (size_in_bytes / 33) - 1.</li></ul></li><li>On all nodes, except for the one determined in step 3, delete the entire data directory of GraphDB.</li><li>On the node chosen in step 3, delete only the <code>raft/</code> subfolder of the data directory.</li><li>Start the GraphDB processes again.</li><li>Create the cluster again, but <strong>make sure to issue the request to the node that was chosen in step 3</strong></li></ol><p>For example, let&#x27;s assume we have three nodes: <code>graphdb1.example.com</code>, <code>graphdb2.example.com</code> and <code>graphdb3.example.com</code>.
If you have determined that node <code>graphdb2.example.com</code> is the node with the highest number of processed transactions,
the request should be: </p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> -X POST -H </span><span class="token string" style="color:#e3116c">&#x27;Content-type: application/json&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    http://graphdb2.example.com:7200/rest/cluster/config </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -d </span><span class="token string" style="color:#e3116c">&#x27;{</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        &quot;nodes&quot;: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            &quot;graphdb1.example.com:7300&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            &quot;graphdb2.example.com:7300&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            &quot;graphdb3.example.com:7300&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    }&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/graphdb-aws-deployment-guide/docs/emergency-maintenance/EMER-001"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Handling Fault Conditions</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/graphdb-aws-deployment-guide/docs/category/support"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Support</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#recovering-individual-nodes" class="table-of-contents__link toc-highlight">Recovering Individual Nodes</a></li><li><a href="#rebuilding-the-cluster-from-a-single-node" class="table-of-contents__link toc-highlight">Rebuilding the Cluster from a Single Node</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">© Copyright <a href="http://www.ontotext.com">Ontotext AD</a> 2023 All rights reserved</div></div></div></footer></div>
<script src="/graphdb-aws-deployment-guide/assets/js/runtime~main.98a356ba.js"></script>
<script src="/graphdb-aws-deployment-guide/assets/js/main.5c81d43a.js"></script>
</body>
</html>